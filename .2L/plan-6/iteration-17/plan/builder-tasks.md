# Builder Task Breakdown - Iteration 17

## Overview

2 primary builders will work in parallel on isolated features. No dependencies between builders - perfect parallelization opportunity.

**Estimated total time:** 6-8 hours (parallel execution)

---

## Builder-1: Database Schema & Encryption Infrastructure

### Scope

Establish secure database foundation and encryption patterns for bank credential storage. This builder creates the data layer that Builder-2's API will consume.

### Complexity Estimate

**MEDIUM**

Database schema design requires careful consideration of relationships and indexes, but patterns are well-established from existing Account/Transaction models. Encryption extension is straightforward.

### Success Criteria

- [ ] Prisma schema includes BankConnection model (9 fields)
- [ ] Prisma schema includes SyncLog model (7 fields)
- [ ] Transaction model enhanced with 5 import fields (all nullable)
- [ ] 7 new enums added (BankProvider, ConnectionStatus, etc.)
- [ ] Migration created and tested locally
- [ ] Migration applied to staging Supabase successfully
- [ ] Encryption functions added to `encryption.ts`
- [ ] `encryptBankCredentials` / `decryptBankCredentials` working
- [ ] 8+ encryption tests written and passing
- [ ] Cascade delete verified (delete connection → sync logs deleted)
- [ ] No TypeScript errors
- [ ] All tests pass

### Files to Create

- `src/lib/__tests__/bank-credentials-encryption.test.ts` - Encryption tests (8+ test cases)
- `prisma/migrations/YYYYMMDDHHMMSS_add_bank_connections_foundation/migration.sql` - Auto-generated by Prisma

### Files to Modify

- `prisma/schema.prisma` - Add BankConnection, SyncLog models + 7 enums + enhance Transaction
- `src/lib/encryption.ts` - Add BankCredentials interface + encryptBankCredentials + decryptBankCredentials functions

### Dependencies

**Depends on:** None (foundation layer)

**Blocks:** Builder-2 (API layer depends on database schema)

### Implementation Notes

#### Step 1: Update Prisma Schema (45 minutes)

**Location:** `prisma/schema.prisma`

**Add after User model section:**

```prisma
// ============================================================================
// BANK INTEGRATIONS (ITERATION 17)
// ============================================================================

enum BankProvider {
  FIBI          // First International Bank of Israel (031)
  VISA_CAL      // Visa CAL credit card
}

enum ConnectionStatus {
  ACTIVE
  ERROR
  EXPIRED
}

enum SyncStatus {
  SUCCESS
  PARTIAL
  FAILED
}

enum ImportSource {
  MANUAL
  FIBI
  CAL
  PLAID
}

enum CategorizationSource {
  USER          // Manually categorized
  AI_CACHED     // From MerchantCategoryCache
  AI_SUGGESTED  // From Claude API
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

model BankConnection {
  id                    String            @id @default(cuid())
  userId                String
  bank                  BankProvider
  accountType           AccountType       // Reuse existing enum
  encryptedCredentials  String            @db.Text
  accountIdentifier     String            // Last 4 digits
  status                ConnectionStatus  @default(ACTIVE)
  lastSynced            DateTime?
  lastSuccessfulSync    DateTime?
  errorMessage          String?           @db.Text
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs  SyncLog[]

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([lastSynced])
}

model SyncLog {
  id                    String      @id @default(cuid())
  bankConnectionId      String
  startedAt             DateTime
  completedAt           DateTime?
  status                SyncStatus
  transactionsImported  Int         @default(0)
  transactionsSkipped   Int         @default(0)
  errorDetails          String?     @db.Text
  createdAt             DateTime    @default(now())

  bankConnection BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)

  @@index([bankConnectionId])
  @@index([createdAt(sort: Desc)])
  @@index([status])
}
```

**Enhance Transaction model (find existing model, add these fields):**

```prisma
model Transaction {
  // ... existing fields ...

  // NEW FIELDS (add these at end before relationships)
  rawMerchantName            String?
  importSource               ImportSource?
  importedAt                 DateTime?
  categorizedBy              CategorizationSource?
  categorizationConfidence   ConfidenceLevel?

  // ... existing relationships ...

  // ... existing indexes ...
  @@index([importSource])  // NEW INDEX
}
```

**Update User model relationships (add this line):**

```prisma
model User {
  // ... existing fields ...
  bankConnections       BankConnection[]  // ADD THIS LINE
  // ... rest of relationships ...
}
```

#### Step 2: Create Migration (15 minutes)

**Commands:**

```bash
# 1. Create migration
npx prisma migrate dev --name add-bank-connections-foundation

# 2. Review generated SQL
cat prisma/migrations/*_add_bank_connections_foundation/migration.sql

# 3. Verify in Prisma Studio
npx prisma studio

# 4. Check no errors
npm run build
```

**Expected SQL:** Create 2 tables, 7 enums, add 5 columns to Transaction, add indexes

**Rollback if needed:**

```bash
npx prisma migrate resolve --rolled-back YYYYMMDDHHMMSS_add_bank_connections_foundation
```

#### Step 3: Extend Encryption Module (30 minutes)

**File:** `src/lib/encryption.ts`

**Add after existing functions:**

```typescript
/**
 * Bank credentials structure for encryption
 */
export interface BankCredentials {
  userId: string       // Bank user ID (not Wealth user ID)
  password: string     // Bank password
  otp?: string        // Optional 2FA code
}

/**
 * Encrypts bank credentials for secure database storage.
 *
 * SECURITY NOTE: Credentials are decrypted only in-memory during sync operations.
 * Never log decrypted credentials or store them in plaintext.
 */
export function encryptBankCredentials(credentials: BankCredentials): string {
  return encrypt(JSON.stringify(credentials))
}

/**
 * Decrypts bank credentials from database storage.
 *
 * SECURITY WARNING:
 * - Only call this in sync operations (server-side only)
 * - Clear credentials from memory after use
 * - Never log the result
 */
export function decryptBankCredentials(encrypted: string): BankCredentials {
  const json = decrypt(encrypted)
  const credentials = JSON.parse(json) as BankCredentials

  // Validate required fields
  if (!credentials.userId || !credentials.password) {
    throw new Error('Invalid credentials: userId and password required')
  }

  return credentials
}
```

#### Step 4: Write Encryption Tests (45 minutes)

**File:** `src/lib/__tests__/bank-credentials-encryption.test.ts`

**Copy full test suite from `patterns.md` section "Pattern: Testing Encryption"**

**Test cases:**

1. Encrypt/decrypt round-trip
2. Credentials with OTP
3. Different ciphertext for same credentials (random IV)
4. Special characters in password
5. Hebrew characters (Israeli banks)
6. Invalid encrypted format
7. Tampered ciphertext
8. Missing required fields

**Run tests:**

```bash
npm test encryption
```

#### Step 5: Verify Cascade Deletes (30 minutes)

**Integration test approach:**

```typescript
// In bankConnections.router.test.ts (Builder-2 will create this file)
describe('Cascade Deletes', () => {
  it('should delete sync logs when connection deleted', async () => {
    // 1. Create bank connection
    const connection = await prisma.bankConnection.create({ ... })

    // 2. Create sync log
    const syncLog = await prisma.syncLog.create({
      data: { bankConnectionId: connection.id, ... }
    })

    // 3. Delete connection
    await prisma.bankConnection.delete({ where: { id: connection.id } })

    // 4. Verify sync log deleted
    const orphan = await prisma.syncLog.findUnique({ where: { id: syncLog.id } })
    expect(orphan).toBeNull()
  })
})
```

**Manual verification:**

```bash
# 1. Open Prisma Studio
npx prisma studio

# 2. Create BankConnection record
# 3. Create SyncLog record linked to connection
# 4. Delete BankConnection
# 5. Verify SyncLog deleted automatically
```

### Testing Requirements

- **Unit tests:** 8+ test cases for encryption functions
- **Integration tests:** Cascade delete verification
- **Coverage target:** 85% for encryption.ts additions

### Patterns to Follow

**From `patterns.md`:**

- "Pattern: Adding New Models" - Prisma schema structure
- "Pattern: Enhancing Existing Models" - Transaction fields
- "Pattern: Bank Credential Encryption" - Encryption functions
- "Pattern: Testing Encryption" - Test suite

### Gotchas & Edge Cases

**Gotcha 1: User model relationship**

- Don't forget to add `bankConnections BankConnection[]` to User model
- Without it, Prisma will error on relation definition

**Gotcha 2: AccountType enum reuse**

- BankConnection uses existing AccountType enum
- Only CHECKING and CREDIT supported for Israeli banks
- Validation happens in tRPC layer (Builder-2)

**Gotcha 3: Migration rollback**

- If migration fails, use `prisma migrate resolve --rolled-back`
- Don't manually edit migrations after creation
- Test on local DB first, then staging

**Gotcha 4: Encryption key verification**

- Tests will fail if `ENCRYPTION_KEY` not set
- Copy `.env.example` to `.env.local` before testing
- Verify key is 64-character hex string

### Potential Split Strategy

**NOT NEEDED** - Complexity is MEDIUM, well within single builder scope. Tasks are sequential (schema → migration → encryption → tests).

---

## Builder-2: tRPC API Layer & Settings UI

### Scope

Create type-safe API endpoints for bank connection management and basic settings page UI to display connections. This builder creates the application layer that consumes Builder-1's database schema.

### Complexity Estimate

**MEDIUM**

tRPC router follows established patterns from 11 existing routers. UI is straightforward list view with delete confirmation. No complex forms or wizards in this iteration.

### Success Criteria

- [ ] `bankConnections.router.ts` created with 6 endpoints
- [ ] Router registered in `root.ts`
- [ ] All endpoints use `protectedProcedure`
- [ ] Ownership verification on all mutations
- [ ] Zod schemas validate all inputs
- [ ] Settings page updated with bank connections card
- [ ] Bank connections list page created
- [ ] Empty state displays correctly
- [ ] Delete confirmation dialog works
- [ ] Toast notifications on success/error
- [ ] No TypeScript errors
- [ ] All endpoints return expected data structures

### Files to Create

- `src/server/api/routers/bankConnections.router.ts` - tRPC router (6 endpoints, ~250 lines)
- `src/app/(dashboard)/settings/bank-connections/page.tsx` - Settings page (~200 lines)

### Files to Modify

- `src/server/api/root.ts` - Import and register bankConnectionsRouter (2 lines)
- `src/app/(dashboard)/settings/page.tsx` - Add bank connections card to settingsSections array (~10 lines)

### Dependencies

**Depends on:** Builder-1 (database schema must exist)

**Blocks:** None (final layer in iteration)

### Implementation Notes

#### Step 1: Create tRPC Router (90 minutes)

**File:** `src/server/api/routers/bankConnections.router.ts`

**Copy full router from `patterns.md` section "Pattern: Bank Connections Router Structure"**

**Endpoints:**

1. `list` (query) - Get all user's connections with latest sync log
2. `get` (query) - Get single connection with 10 recent sync logs
3. `add` (mutation) - Create connection with encrypted credentials
4. `update` (mutation) - Update status/credentials/error message
5. `delete` (mutation) - Delete connection (cascade to sync logs)
6. `test` (mutation) - Test connection (stub - always returns success)

**Key implementation points:**

- Import Prisma enums: `BankProvider`, `ConnectionStatus`, `AccountType`
- Import encryption: `encryptBankCredentials`, `decryptBankCredentials`
- Verify ownership before all mutations
- Use `ctx.user.id` from protectedProcedure
- Throw `NOT_FOUND` for unauthorized access (not `FORBIDDEN`)
- Sanitize logs (never log credentials)

#### Step 2: Register Router (5 minutes)

**File:** `src/server/api/root.ts`

**Add import:**

```typescript
import { bankConnectionsRouter } from './routers/bankConnections.router'
```

**Add to router object:**

```typescript
export const appRouter = router({
  // ... existing routers ...
  bankConnections: bankConnectionsRouter,
})
```

#### Step 3: Update Settings Index (10 minutes)

**File:** `src/app/(dashboard)/settings/page.tsx`

**Add import:**

```typescript
import { Landmark } from 'lucide-react'
```

**Add to settingsSections array:**

```typescript
{
  title: 'Bank Connections',
  description: 'Connect Israeli bank accounts for automatic transaction import',
  href: '/settings/bank-connections',
  icon: Landmark,
}
```

#### Step 4: Create Bank Connections Page (90 minutes)

**File:** `src/app/(dashboard)/settings/bank-connections/page.tsx`

**Copy full page from `patterns.md` section "Pattern: Bank Connections List Page"**

**Components used:**

- `Card` / `CardHeader` / `CardContent` / `CardTitle` / `CardDescription`
- `Button` (Add Bank - disabled, Delete)
- `Badge` (status indicators with colors)
- `AlertDialog` (delete confirmation)
- `EmptyState` (no connections)
- `Breadcrumb`
- Icons: `Landmark`, `Plus`, `Trash2`, `AlertCircle`, `CheckCircle`, `XCircle`

**Features:**

- Display list of connections with status badges
- Delete confirmation dialog
- Toast notifications on success/error
- Empty state for no connections
- Loading state while fetching
- Status-specific badge styling (green/red/orange)
- Disabled "Add Bank" button (wizard coming in Iteration 18)
- Informational card explaining wizard is next iteration

**React Query:**

- `api.bankConnections.list.useQuery()` - Fetch connections
- `api.bankConnections.delete.useMutation()` - Delete connection
- `utils.bankConnections.list.invalidate()` - Refetch after delete

#### Step 5: Test Endpoints Manually (30 minutes)

**Using tRPC Panel or Postman:**

1. **List connections** - Should return empty array for new user
2. **Add connection** - Create test connection with mock credentials
3. **Get connection** - Fetch by ID, verify ownership check works
4. **Update connection** - Change status to ERROR
5. **Delete connection** - Verify deletion works
6. **Test unauthorized access** - Try to access other user's connection (should 404)

**Using UI:**

1. Navigate to `/settings/bank-connections`
2. Verify empty state displays
3. (Cannot test add until Iteration 18 wizard)
4. If manually created connection via tRPC, verify it displays
5. Click delete, confirm dialog appears
6. Delete connection, verify toast notification

### Testing Requirements

- **Integration tests:** 10+ test cases for router endpoints
- **Manual testing:** UI flows (empty state, delete confirmation)
- **Coverage target:** 60% for router (ownership checks, CRUD operations)

### Patterns to Follow

**From `patterns.md`:**

- "Pattern: Bank Connections Router Structure" - Full router implementation
- "Pattern: Router Registration" - Adding to root.ts
- "Pattern: Settings Page Integration" - Adding card
- "Pattern: Bank Connections List Page" - Full page implementation

### Gotchas & Edge Cases

**Gotcha 1: Builder-1 dependency**

- Cannot start until Builder-1 completes migration
- Prisma types won't exist until schema is migrated
- Coordinate handoff point with Builder-1

**Gotcha 2: Empty state vs loading state**

- Empty state: connections.length === 0 && !isLoading
- Loading state: isLoading === true
- Don't show empty state while loading

**Gotcha 3: Delete confirmation state**

- Track `deleteId` in state (string | null)
- Only one dialog open at a time
- Clear deleteId on cancel or success

**Gotcha 4: Status badge colors**

- ACTIVE: green (success variant)
- ERROR: red (destructive variant)
- EXPIRED: orange (outline variant with custom classes)
- Use consistent colors across app

**Gotcha 5: Test endpoint is stub**

- Always returns success in Iteration 17
- Real implementation in Iteration 18 with israeli-bank-scrapers
- Add clear console.log noting it's a stub

### Potential Split Strategy

**NOT NEEDED** - Complexity is MEDIUM, two distinct files (router + UI). Could split if needed, but recommended to keep together for cohesion.

If split becomes necessary:

**Foundation (Primary Builder-2):**

- Create router with 6 endpoints
- Register in root.ts
- Write router tests

**Sub-builder 2A (if needed):**

- Update settings index page
- Create bank connections list page
- Manual UI testing

**Handoff point:** Router must be complete and tested before UI can consume it.

---

## Builder Execution Order

### Phase 1: Parallel (No dependencies)

**Builder-1** and **Builder-2 prep** can start simultaneously:

- Builder-1: Begin Prisma schema design
- Builder-2: Review existing router patterns, plan API structure

### Phase 2: Sequential

**Builder-1 completes → Builder-2 starts implementation:**

1. Builder-1 finishes migration (schema available)
2. Builder-1 completes encryption functions
3. Builder-1 runs tests
4. **Handoff:** Builder-2 pulls schema, Prisma generates types
5. Builder-2 implements router (can now import Prisma enums)
6. Builder-2 implements UI
7. Builder-2 tests endpoints

### Integration Notes

**Merge order:**

1. Merge Builder-1 changes first (foundation)
2. Run `npm run db:migrate` locally
3. Run `npx prisma generate` to generate types
4. Merge Builder-2 changes (API + UI)
5. Run `npm run build` to verify compilation
6. Run `npm test` to verify all tests pass

**Conflict resolution:**

- **No conflicts expected** - builders work on separate files
- Only potential conflict: `src/server/api/root.ts` (manual merge if both edit)

**Shared files:**

- `prisma/schema.prisma` - Only Builder-1 touches
- `src/lib/encryption.ts` - Only Builder-1 touches
- `src/server/api/root.ts` - Only Builder-2 touches
- `src/app/(dashboard)/settings/page.tsx` - Only Builder-2 touches

---

## Quality Checklist

Before marking iteration complete, verify:

### Database & Schema

- [ ] Prisma migration applied successfully to staging
- [ ] BankConnection and SyncLog models created
- [ ] Transaction model enhanced with 5 fields
- [ ] 7 enums added (BankProvider, ConnectionStatus, etc.)
- [ ] Cascade delete works (verified manually in Prisma Studio)
- [ ] All indexes created correctly

### Encryption

- [ ] `encryptBankCredentials` function works
- [ ] `decryptBankCredentials` function works
- [ ] Round-trip encryption/decryption successful
- [ ] 8+ test cases passing
- [ ] No credentials logged anywhere

### API Layer

- [ ] 6 endpoints implemented (list, get, add, update, delete, test)
- [ ] Router registered in root.ts
- [ ] All endpoints use `protectedProcedure`
- [ ] Ownership verification on all mutations
- [ ] Zod schemas validate inputs
- [ ] Error handling with proper codes

### UI Layer

- [ ] Settings page has bank connections card
- [ ] Bank connections page renders
- [ ] Empty state displays correctly
- [ ] Delete confirmation dialog works
- [ ] Toast notifications on actions
- [ ] Status badges styled correctly
- [ ] Loading states work

### Testing

- [ ] Encryption tests pass (8+ cases)
- [ ] Router integration tests pass (if time permits)
- [ ] Manual testing completed (UI flows)
- [ ] TypeScript compilation successful
- [ ] No console errors

### Security

- [ ] No credentials in logs (verified)
- [ ] Ownership checks on all mutations
- [ ] ENCRYPTION_KEY in environment variables
- [ ] Cascade deletes prevent orphaned data

### Documentation

- [ ] Code comments on security-critical functions
- [ ] JSDoc on encryption functions
- [ ] Migration SQL reviewed and approved

---

**Builder Tasks Status:** COMPREHENSIVE
**Ready for:** Parallel execution
**Estimated time:** 6-8 hours total (parallel)
**Risk level:** LOW-MEDIUM
