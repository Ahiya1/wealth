# Integration Plan - Round 1

**Created:** 2025-11-19T14:23:00Z
**Iteration:** plan-6/iteration-17
**Total builders to integrate:** 2

---

## Executive Summary

This is a CLEAN integration with zero conflicts. Both builders completed successfully and worked on entirely separate files with clear dependency handoff. Builder-1 established the database foundation (schema + encryption), and Builder-2 consumed those exports to build the API and UI layers. All modifications are additive, and both builders explicitly confirmed seamless integration.

Key insights:
- Perfect parallel execution - no file overlap between builders
- All type dependencies resolved via Prisma-generated types (no custom shared types)
- Builder-2 successfully imported all Builder-1 exports (encryption functions, Prisma models, enums)
- No pattern conflicts - both followed established conventions from patterns.md
- All tests passing (200 total, including 9 new encryption tests)
- Zero TypeScript compilation errors

---

## Builders to Integrate

### Primary Builders
- **Builder-1:** Database Schema & Encryption Infrastructure - Status: COMPLETE
- **Builder-2:** tRPC API Layer & Settings UI - Status: COMPLETE

### Sub-Builders
None - Both builders completed without splitting

**Total outputs to integrate:** 2

---

## Integration Zones

### Zone 1: Direct File Merge (No Conflicts)

**Builders involved:** Builder-1, Builder-2

**Conflict type:** None - Independent files

**Risk level:** LOW

**Description:**
Both builders created entirely separate files with no overlap. Builder-1 focused on database/encryption foundation, while Builder-2 built the API/UI layer. The only shared aspect is Builder-2's imports from Builder-1's exports, which are all Prisma-generated types and encryption functions - no custom interfaces or shared type definitions.

**Files affected:**
- `prisma/migrations/20251119013904_add_bank_connections_foundation/migration.sql` - Builder-1 only
- `src/lib/__tests__/bank-credentials-encryption.test.ts` - Builder-1 only
- `scripts/verify-cascade-delete.ts` - Builder-1 only
- `src/lib/encryption.ts` - Builder-1 only (extended existing file)
- `prisma/schema.prisma` - Builder-1 only (extended existing file)
- `src/server/api/routers/bankConnections.router.ts` - Builder-2 only (new file)
- `src/app/(dashboard)/settings/bank-connections/page.tsx` - Builder-2 only (new file)
- `src/server/api/root.ts` - Builder-2 only (additive modification)
- `src/app/(dashboard)/settings/page.tsx` - Builder-2 only (additive modification)

**Integration strategy:**
1. Merge all Builder-1 files first (database foundation must exist before API)
2. Apply database migration to local/staging database
3. Run `npx prisma generate` to generate TypeScript types
4. Merge all Builder-2 files (API/UI layer consumes generated types)
5. Verify TypeScript compilation succeeds
6. Run all tests to ensure 200/200 passing
7. Manual smoke test: navigate to settings page, verify bank connections section exists

**Expected outcome:**
All files merged successfully with zero conflicts. Database migration applied, Prisma types generated, API endpoints functional, UI rendering correctly.

**Assigned to:** Integrator-1

**Estimated complexity:** LOW

---

### Zone 2: Dependency Verification

**Builders involved:** Builder-1 (provider), Builder-2 (consumer)

**Conflict type:** Import/Export validation

**Risk level:** LOW

**Description:**
Builder-2 imports several exports from Builder-1. Need to verify all imports resolve correctly and match the exported signatures. This is a validation zone, not a conflict resolution zone.

**Files affected:**
- `src/server/api/routers/bankConnections.router.ts` - Imports from Builder-1

**Import dependencies to verify:**
```typescript
// From Prisma (generated by Builder-1's schema)
import { BankProvider, ConnectionStatus, AccountType, SyncStatus } from '@prisma/client'

// From encryption module (extended by Builder-1)
import { encryptBankCredentials, decryptBankCredentials, type BankCredentials } from '@/lib/encryption'

// From Prisma Client (models created by Builder-1)
// Used via ctx.prisma.bankConnection and ctx.prisma.syncLog
```

**Integration strategy:**
1. After merging Builder-1 files, run `npx prisma generate`
2. Verify all Prisma enums exist: `BankProvider`, `ConnectionStatus`, `SyncStatus`, `ImportSource`, `CategorizationSource`, `ConfidenceLevel`
3. Verify encryption exports exist: `encryptBankCredentials`, `decryptBankCredentials`, `BankCredentials` interface
4. Merge Builder-2 files
5. Run TypeScript compiler - should show zero errors
6. If any import errors, check Prisma generation completed successfully

**Expected outcome:**
All imports resolve correctly. TypeScript compilation succeeds with no type errors. All Prisma models and enums available to API layer.

**Assigned to:** Integrator-1

**Estimated complexity:** LOW

---

## Independent Features (Direct Merge)

These builder outputs have no interdependencies and can be merged directly:

- **Builder-1 verification script:** `scripts/verify-cascade-delete.ts` - Standalone integration test for cascade deletes
- **Builder-1 test suite:** `src/lib/__tests__/bank-credentials-encryption.test.ts` - Unit tests for encryption (9 passing)

Both are self-contained and don't interact with Builder-2's work.

**Assigned to:** Integrator-1 (merge alongside main integration work)

---

## Parallel Execution Groups

### Group 1 (Sequential - Required)
- **Integrator-1:** All zones (Zone 1 + Zone 2)

**Rationale:** Only one integrator needed due to clean handoff. Sequential execution required (Builder-1 foundation must be merged before Builder-2 API layer).

**No parallel execution possible** - Builder-2 depends on Builder-1's database schema.

---

## Integration Order

**Recommended sequence:**

1. **Merge Builder-1 foundation**
   - Copy migration file to `prisma/migrations/`
   - Update `prisma/schema.prisma` with new models and enums
   - Extend `src/lib/encryption.ts` with bank credential functions
   - Add encryption test suite
   - Add cascade delete verification script

2. **Apply database migration**
   - Run `npx prisma migrate dev` (or `npx prisma migrate deploy` for staging)
   - Verify migration applied successfully
   - Run `npx prisma generate` to generate TypeScript types
   - Verify types generated: check `node_modules/.prisma/client/index.d.ts`

3. **Merge Builder-2 API/UI layer**
   - Create `src/server/api/routers/bankConnections.router.ts`
   - Update `src/server/api/root.ts` (add import + router registration)
   - Create `src/app/(dashboard)/settings/bank-connections/page.tsx`
   - Update `src/app/(dashboard)/settings/page.tsx` (add bank connections card)

4. **Verification**
   - Run `npm run build` - should succeed with zero TypeScript errors
   - Run `npm test` - should pass 200/200 tests (including 9 new encryption tests)
   - Manual test: navigate to `/settings/bank-connections` - should render empty state

5. **Final consistency check**
   - Verify all imports resolve correctly
   - Check no ESLint violations
   - Confirm all environment variables set (`ENCRYPTION_KEY`)
   - Review security: no credentials in logs

---

## Shared Resources Strategy

### Shared Types
**Issue:** None - All types are Prisma-generated

**Resolution:**
N/A - No custom shared type definitions. All types come from `@prisma/client` generated by Builder-1's schema.

**Responsible:** N/A

### Shared Utilities
**Issue:** None - Builders didn't create overlapping utilities

**Resolution:**
N/A - Builder-1 extended existing `encryption.ts` module. Builder-2 only consumed exports, didn't create competing implementations.

**Responsible:** N/A

### Configuration Files
**Issue:** None - No config file modifications

**Resolution:**
N/A - Both builders used existing environment variables and configuration. No new config files created or modified.

**Responsible:** N/A

---

## Expected Challenges

### Challenge 1: Database Migration Timing
**Impact:** Builder-2 files will have TypeScript errors if migration not applied first
**Mitigation:**
- Ensure migration is applied before merging Builder-2 files
- Run `npx prisma generate` immediately after migration
- Verify generated types exist before continuing
**Responsible:** Integrator-1

### Challenge 2: Environment Variable Verification
**Impact:** Encryption tests will fail if `ENCRYPTION_KEY` not set
**Mitigation:**
- Verify `.env.local` has `ENCRYPTION_KEY` before running tests
- Check key is 64-character hex string (32 bytes)
- Copy from `.env.example` if missing
**Responsible:** Integrator-1

### Challenge 3: Cascade Delete Verification
**Impact:** Need to manually verify cascade deletes work in local database
**Mitigation:**
- Run `npx tsx scripts/verify-cascade-delete.ts` after migration
- Alternatively, verify in Prisma Studio: create connection + sync log, delete connection, verify sync log deleted
- Builder-1 already verified this, but good to confirm in integration environment
**Responsible:** Integrator-1

---

## Success Criteria for This Integration Round

- [x] All zones successfully resolved (no conflicts found)
- [x] No duplicate code remaining (no overlapping implementations)
- [x] All imports resolve correctly (verified via TypeScript compilation)
- [x] TypeScript compiles with no errors (builders confirmed zero errors)
- [x] Consistent patterns across integrated code (both followed patterns.md)
- [x] No conflicts in shared files (no file overlap between builders)
- [x] All builder functionality preserved (both builders COMPLETE)

**Additional verification needed post-integration:**
- [ ] Database migration applied successfully
- [ ] Prisma types generated correctly
- [ ] All 200 tests passing (including 9 new encryption tests)
- [ ] Manual UI test: bank connections page renders
- [ ] No console errors in browser

---

## Notes for Integrators

**Important context:**
- This is a foundation iteration - no actual bank scraping yet (coming in Iteration 18)
- Both builders explicitly noted seamless integration in their reports
- Builder-2 confirmed: "Estimated Integration Time: 5 minutes (merge + verify build)"
- All modifications are additive (no destructive changes to existing code)
- Migration adds new models/enums - doesn't modify existing tables (except Transaction gets 5 nullable fields)

**Watch out for:**
- Ensure migration runs BEFORE merging Builder-2 files (TypeScript will error otherwise)
- Verify `ENCRYPTION_KEY` environment variable is set (tests depend on it)
- Check that Prisma generation succeeds (Builder-2 needs generated types)
- Don't skip test execution - encryption tests are critical for security validation

**Patterns to maintain:**
- Reference `patterns.md` for all conventions (both builders followed this)
- Ensure error handling is consistent (both used tRPC error codes correctly)
- Keep naming conventions aligned (camelCase fields, PascalCase models/enums)
- Maintain security standards (no credentials in logs, ownership verification)

---

## Next Steps

1. Integrator-1 executes integration following the order above
2. Integrator-1 creates integration report confirming success
3. Move to ivalidator for final validation
4. Deploy to staging environment
5. Prepare for Iteration 18 (israeli-bank-scrapers integration)

---

**Integration Planner:** 2l-iplanner
**Plan created:** 2025-11-19T14:23:00Z
**Round:** 1
**Zones identified:** 2
**Conflicts found:** 0
**Risk assessment:** LOW
**Recommended integrators:** 1
**Estimated integration time:** 15-30 minutes
