# Builder Task Breakdown

## Overview

5 primary builders will work in parallel where possible.
Estimated total time: 6-8 hours across all builders.

## Builder Assignment Strategy

- **Builder 1:** Database foundation (must complete first - all others depend on it)
- **Builders 2 & 3:** Backend infrastructure (can work in parallel after Builder 1)
- **Builders 4 & 5:** Frontend implementation (can work in parallel after Builders 2 & 3)

Dependencies are noted explicitly. Builders work on isolated features when possible.

---

## Builder-1: Database Schema & Migration

### Scope

Extend User model with role/tier enums, create first tracked migration, set admin user.

### Complexity Estimate

**MEDIUM**

Critical foundation work. All other builders depend on this. Migration is straightforward but must be tested thoroughly.

### Success Criteria

- [x] UserRole enum (USER, ADMIN) added to schema
- [x] SubscriptionTier enum (FREE, PREMIUM) added to schema
- [x] User model includes role, subscriptionTier, subscriptionStartedAt, subscriptionExpiresAt fields
- [x] Indexes added on role, subscriptionTier, createdAt fields
- [x] Migration generated successfully
- [x] Migration runs successfully on local database
- [x] ahiya.butman@gmail.com user has ADMIN role after migration
- [x] All existing users have USER role and FREE tier after migration
- [x] Prisma Client regenerated with new types
- [x] No data loss (all existing data intact)

### Files to Create

- `prisma/migrations/{timestamp}_add_user_roles_and_subscription_tiers/migration.sql` - Auto-generated by Prisma
- (Optional) `prisma/seed-admin.ts` - Script to set admin user

### Files to Modify

- `prisma/schema.prisma` - Add enums and User model fields

### Dependencies

**Depends on:** None (foundation task)

**Blocks:** All other builders (they need role/tier enums)

### Implementation Notes

**CRITICAL: Test migration on local database before production!**

1. **Add enums BEFORE User model** (Prisma convention)
2. **Use default values** to prevent null constraint violations:
   - `role: UserRole @default(USER)`
   - `subscriptionTier: SubscriptionTier @default(FREE)`
3. **Indexes are important** for admin query performance
4. **Set admin user AFTER migration runs** (can't be in migration SQL, needs to check if user exists)

**Migration Strategy:**
- This will be the FIRST tracked migration (no migration directory exists currently)
- Previous schema changes used `prisma db push` (development only)
- Migration will capture current schema + new changes

**Admin User Setup:**
After migration runs, manually set admin user:
```sql
UPDATE "User"
SET role = 'ADMIN'
WHERE email = 'ahiya.butman@gmail.com';
```

Or use Prisma script (safer):
```typescript
await prisma.user.update({
  where: { email: 'ahiya.butman@gmail.com' },
  data: { role: 'ADMIN' },
})
```

### Patterns to Follow

Reference `patterns.md`:
- **Prisma Schema Convention** section for enum placement
- **Database Patterns** section for field ordering

### Testing Requirements

**Unit tests:** Not required (schema-only changes)

**Manual testing:**
1. Run migration on local database: `npx prisma migrate dev --name add_user_roles_and_subscription_tiers`
2. Open Prisma Studio: `npx prisma studio`
3. Verify User table has new columns: role, subscriptionTier, subscriptionStartedAt, subscriptionExpiresAt
4. Verify all existing users have role = 'USER' and subscriptionTier = 'FREE'
5. Run admin user update script
6. Verify ahiya.butman@gmail.com has role = 'ADMIN'
7. Run `npx prisma generate` and verify TypeScript types available

**Rollback test:**
1. Create rollback migration (remove new fields)
2. Test rollback locally: `npx prisma migrate reset` (DESTRUCTIVE - local only)

### Potential Issues

**Issue 1: Migration fails due to existing data**
- **Likelihood:** LOW (default values prevent this)
- **Solution:** Check Prisma migration logs, ensure default values are set

**Issue 2: Admin user email not found**
- **Likelihood:** LOW (user exists in production)
- **Solution:** Verify user exists before running update script, create user if needed

**Issue 3: Prisma Client types not updating**
- **Likelihood:** LOW
- **Solution:** Restart TypeScript server, run `npx prisma generate` again

---

## Builder-2: Backend API Layer (tRPC)

### Scope

Create `adminProcedure` middleware, build `admin.router.ts` with system metrics and user list procedures, update `users.router.ts` to include role/tier fields.

### Complexity Estimate

**MEDIUM-HIGH**

Most complex backend work. Requires careful role validation, aggregation queries, pagination logic.

### Success Criteria

- [x] adminProcedure middleware created in `server/api/trpc.ts`
- [x] adminProcedure validates role on every call (throws FORBIDDEN for non-admin)
- [x] admin.router.ts created with systemMetrics and userList procedures
- [x] systemMetrics returns accurate counts (totalUsers, totalTransactions, etc.)
- [x] userList supports search (email/name), filter (role/tier), pagination (cursor-based)
- [x] admin router registered in `server/api/root.ts`
- [x] users.router.ts updated: `me` query includes role and subscriptionTier
- [x] All procedures use proper error handling
- [x] Type safety maintained (TypeScript errors resolved)
- [x] Client autocomplete works for admin procedures

### Files to Create

- `src/server/api/routers/admin.router.ts` - Admin-only procedures

### Files to Modify

- `src/server/api/trpc.ts` - Add adminProcedure middleware
- `src/server/api/root.ts` - Register admin router
- `src/server/api/routers/users.router.ts` - Update me query

### Dependencies

**Depends on:** Builder 1 (needs role/tier enums from Prisma)

**Blocks:** Builders 4 & 5 (they need admin tRPC procedures)

### Implementation Notes

**adminProcedure Security:**
- ALWAYS fetch fresh role from database (don't trust context)
- Use FORBIDDEN code for authorization errors (UNAUTHORIZED for authentication)
- Log admin access attempts in development mode
- Return narrowed context type (admin user only)

**Performance Considerations:**
- Use `Promise.all()` for parallel queries in systemMetrics
- Use cursor-based pagination (not offset) for userList
- Keep queries lean (select only needed fields)

**Active Users Definition:**
- 30d active = users with transactions in last 30 days
- 90d active = users with transactions in last 90 days
- Use `transactions: { some: { date: { gte: dateThreshold } } }` pattern

### Patterns to Follow

Reference `patterns.md`:
- **Admin Procedure Pattern** section (exact code for adminProcedure)
- **Admin Router Pattern** section (full router implementation)
- **Query Patterns** section (aggregation, pagination)
- **tRPC Patterns** section (procedure structure)

### Testing Requirements

**Unit tests (Optional):**
- Test adminProcedure throws FORBIDDEN for non-admin user
- Test systemMetrics returns expected structure
- Test userList pagination logic

**Manual testing:**
1. Sign in as regular user (not admin)
2. Open browser console
3. Attempt to call `trpc.admin.systemMetrics.query()`
4. Expected: Error "Admin access required" (FORBIDDEN)
5. Sign in as admin user
6. Call `trpc.admin.systemMetrics.query()`
7. Expected: Returns metrics object with all fields
8. Call `trpc.admin.userList.query({ search: 'test', limit: 10 })`
9. Expected: Returns paginated user list
10. Test `trpc.users.me.useQuery()` includes role and subscriptionTier

**Coverage target:** Not required for MVP

### Potential Split Strategy

If complexity is too high, consider splitting:

**Foundation (Primary Builder 2):**
- adminProcedure middleware
- users.router.ts update
- Register admin router

**Sub-builder 2A: Admin Metrics**
- systemMetrics procedure
- Aggregation queries
- Estimate: LOW-MEDIUM

**Sub-builder 2B: Admin User List**
- userList procedure
- Search/filter/pagination logic
- Estimate: MEDIUM

**Recommendation:** Keep as single builder (procedures are related, share patterns)

---

## Builder-3: Middleware Security

### Scope

Extend `middleware.ts` to protect `/admin` routes with server-side role checking, add `/account` to protected paths.

### Complexity Estimate

**MEDIUM**

Security-critical work. Must be done correctly. Relatively isolated from other builders.

### Success Criteria

- [x] middleware.ts protects `/admin` routes with role checking
- [x] Non-authenticated users redirected from `/admin` to `/signin`
- [x] Non-admin users redirected from `/admin` to `/dashboard` with error message
- [x] Admin users can access `/admin` routes without issues
- [x] `/account` added to protected paths (requires authentication)
- [x] No performance degradation (role check adds <50ms)
- [x] Clear error messages without revealing system internals
- [x] Development logging for admin access attempts

### Files to Create

None (modifies existing file)

### Files to Modify

- `middleware.ts` - Add admin route protection logic

### Dependencies

**Depends on:** Builder 1 (needs Prisma User model with role field)

**Blocks:** Builder 5 (admin pages need middleware protection to work)

### Implementation Notes

**Critical Security Points:**
1. **Server-side only:** Never trust client-side role checks
2. **Fetch fresh role:** Query Prisma for current role (don't cache yet)
3. **Lean query:** Select only `role` field (performance)
4. **Clear errors:** "Unauthorized access" (not "You're not admin")
5. **Redirect with message:** Use query param `?error=unauthorized`

**Performance:**
- Single database query per `/admin` request
- Use existing index on role field (fast)
- Monitor in development mode (log query time)
- If >100ms consistently, consider caching (future iteration)

**Import Prisma in Middleware:**
```typescript
import { prisma } from '@/lib/prisma'
```
This works because middleware runs on server-side.

### Patterns to Follow

Reference `patterns.md`:
- **Middleware Patterns** section (exact code for admin protection)
- **Admin Route Protection** section (complete example)

### Testing Requirements

**Security testing (CRITICAL):**
1. Sign in as regular user (not admin)
2. Navigate to `/admin` directly in browser
3. Expected: Redirect to `/dashboard?error=unauthorized`
4. Check that error message displays (Builder 4 will handle this)
5. Sign in as admin user (ahiya.butman@gmail.com)
6. Navigate to `/admin`
7. Expected: Page loads successfully (Builder 5 creates the page)
8. Test `/account` routes require authentication
9. Sign out, try `/account/profile`
10. Expected: Redirect to `/signin`

**Performance testing:**
1. Add timing logs in development mode
2. Navigate to `/admin` multiple times
3. Check console for role check duration
4. Expected: <50ms per request

**Edge case testing:**
1. Prisma user doesn't exist (Supabase user valid, no Prisma record)
2. Expected: Redirect to `/dashboard` with error
3. User role changes mid-session (admin → user)
4. Expected: Next request blocks admin access

### Potential Issues

**Issue 1: Prisma import fails in middleware**
- **Likelihood:** LOW
- **Solution:** Ensure `@/lib/prisma` exports singleton instance correctly

**Issue 2: Redirect loop**
- **Likelihood:** LOW (if logic is wrong)
- **Solution:** Verify redirect logic doesn't apply to `/dashboard`

**Issue 3: Performance degradation**
- **Likelihood:** LOW
- **Solution:** Monitor logs, optimize if needed (future caching)

---

## Builder-4: Navigation & Route Structure

### Scope

Refactor DashboardSidebar with avatar dropdown, fix Settings link, restructure routes for Settings/Account sections, create breadcrumb component, add placeholder pages.

### Complexity Estimate

**MEDIUM-HIGH**

Large scope (many files), but most are straightforward. Avatar dropdown is most complex part.

### Success Criteria

- [x] DashboardSidebar refactored with avatar dropdown (Radix DropdownMenu)
- [x] Settings link points to `/settings` (not `/settings/categories`)
- [x] Admin link conditionally visible (only for admin users)
- [x] Avatar dropdown includes account links (overview, profile, membership, security) and sign out
- [x] Sign out moved from sidebar button to dropdown
- [x] Breadcrumb component created and working
- [x] Settings section routes created: /settings, /settings/currency, /settings/appearance, /settings/data
- [x] Account section routes created: /account, /account/profile, /account/membership, /account/security, /account/preferences
- [x] All pages include breadcrumb navigation
- [x] All pages have proper metadata (title, description)
- [x] PageTransition wrapper applied to all pages
- [x] Old `/settings/account` redirects to `/account`
- [x] All internal links updated (no broken links)

### Files to Create

- `src/components/ui/breadcrumb.tsx` - Breadcrumb component
- `src/app/(dashboard)/settings/currency/page.tsx` - Placeholder
- `src/app/(dashboard)/settings/appearance/page.tsx` - Theme switcher
- `src/app/(dashboard)/settings/data/page.tsx` - Export functionality
- `src/app/(dashboard)/account/page.tsx` - Account overview
- `src/app/(dashboard)/account/profile/page.tsx` - Profile form
- `src/app/(dashboard)/account/membership/page.tsx` - Tier badge
- `src/app/(dashboard)/account/security/page.tsx` - Danger zone
- `src/app/(dashboard)/account/preferences/page.tsx` - Timezone, notifications

### Files to Modify

- `src/components/dashboard/DashboardSidebar.tsx` - Major refactor (avatar dropdown, fix links, add admin link)
- `src/app/(dashboard)/settings/page.tsx` - Expand overview with new sections
- `src/app/(dashboard)/settings/account/page.tsx` - Add redirect to `/account`

### Dependencies

**Depends on:** Builders 1 & 2 (needs `trpc.users.me` with role/tier)

**Blocks:** Builder 5 (admin pages depend on navigation structure)

### Implementation Notes

**DashboardSidebar Refactor:**
1. Keep existing structure (logo, nav items, user section)
2. Fix Settings link (most important!)
3. Add admin link conditionally based on `userData?.role === 'ADMIN'`
4. Replace user section with DropdownMenu
5. Move sign out to dropdown
6. Use `trpc.users.me.useQuery()` to get user data

**Breadcrumb Auto-Generation:**
- Split pathname by `/`
- Capitalize each segment
- Make each segment clickable except last
- Use ChevronRight icon between segments

**Settings vs Account Decision Framework:**
- **Settings:** App-level configuration (categories, currency, appearance, data)
- **Account:** Personal/billing (profile, membership, security, preferences)

**Component Migration:**
- Move `ProfileSection` to `/account/profile`
- Move `ThemeSwitcher` to `/settings/appearance`
- Move `DangerZone` to `/account/security`
- Move timezone field to `/account/preferences`

**Placeholder Pages:**
- Display current value (if applicable)
- Clear "Coming Soon" message
- Maintain consistent structure (breadcrumb, heading, card)

### Patterns to Follow

Reference `patterns.md`:
- **Avatar Dropdown Pattern** section (exact code for dropdown)
- **Breadcrumb Component** section (full component code)
- **Page Structure** section (consistent layout)
- **Placeholder Page Pattern** section (currency example)

### Testing Requirements

**Navigation testing:**
1. Click each sidebar link, verify correct page loads
2. Click Settings link, verify goes to `/settings` (not categories)
3. Click avatar, verify dropdown opens
4. Click each dropdown item, verify navigation works
5. Click Sign Out in dropdown, verify logout works
6. Test breadcrumb links on each page
7. Verify admin link only visible to admin user

**Regression testing:**
1. Test all existing navigation still works
2. Verify no broken links throughout app
3. Test mobile responsiveness (if applicable)

**Content verification:**
1. Verify ProfileSection moved correctly to /account/profile
2. Verify ThemeSwitcher works in /settings/appearance
3. Verify DangerZone works in /account/security
4. Verify all pages have correct metadata

**Coverage target:** Manual testing only (UI-heavy)

### Potential Split Strategy

If complexity is too high, consider splitting:

**Foundation (Primary Builder 4):**
- DashboardSidebar refactor (avatar dropdown, fix links)
- Breadcrumb component
- Route structure (empty pages)

**Sub-builder 4A: Settings Pages**
- /settings overview update
- /settings/currency, /settings/appearance, /settings/data
- Component migration (ThemeSwitcher)
- Estimate: LOW-MEDIUM

**Sub-builder 4B: Account Pages**
- /account overview
- /account/profile, /account/membership, /account/security, /account/preferences
- Component migration (ProfileSection, DangerZone)
- Estimate: MEDIUM

**Recommendation:** Keep as single builder if comfortable with scope. Split if avatar dropdown proves complex.

---

## Builder-5: Admin Pages & Components

### Scope

Create admin dashboard with system metrics, admin user list page with search/filter, admin-specific components.

### Complexity Estimate

**MEDIUM**

Straightforward UI work using tRPC queries from Builder 2. Most complex part is user list table with search/filter.

### Success Criteria

- [x] `/admin` page created with system metrics display
- [x] SystemMetrics component displays all metrics from tRPC query
- [x] Metrics displayed in responsive grid (4 cards on desktop, 1 on mobile)
- [x] Loading states handled (skeleton UI)
- [x] Error states handled (clear error message)
- [x] `/admin/users` page created with user list table
- [x] UserListTable component displays user data (email, name, role, tier, created date, transaction count)
- [x] Search bar filters by email/name
- [x] Role filter dropdown (USER, ADMIN, All)
- [x] Tier filter dropdown (FREE, PREMIUM, All)
- [x] Pagination controls work (cursor-based)
- [x] All pages include breadcrumb navigation
- [x] All pages have proper metadata
- [x] Admin-only content (no admin editing - read-only)

### Files to Create

- `src/app/(dashboard)/admin/page.tsx` - Admin dashboard
- `src/app/(dashboard)/admin/users/page.tsx` - User list page
- `src/components/admin/SystemMetrics.tsx` - Metrics display component
- `src/components/admin/UserListTable.tsx` - User table component (optional - can be inline)

### Files to Modify

None (all new files)

### Dependencies

**Depends on:** Builders 1, 2, 3, 4 (needs database, tRPC, middleware, navigation)

**Blocks:** None (final builder)

### Implementation Notes

**System Metrics Display:**
- Use Card components for each metric
- Include icons from lucide-react (Users, Receipt, Wallet, TrendingUp)
- Display primary value (large, bold) and secondary description (small, muted)
- Use responsive grid (1 col mobile → 4 cols desktop)

**User List Table:**
- Use HTML table or shadcn/ui Table component
- Display: Email, Name, Role badge, Tier badge, Created date, Transaction count
- Search input with debounce (300ms)
- Filter dropdowns for role and tier
- "Load More" button for pagination (cursor-based)
- No editing - read-only for MVP

**Badge Styling:**
- ADMIN role: Red badge with Shield icon
- USER role: Gray badge
- PREMIUM tier: Gold badge with Star icon
- FREE tier: Gray badge

**Loading States:**
- Skeleton cards for metrics (4 loading cards)
- Table skeleton for user list (5 rows with shimmer)

**Error States:**
- Destructive-colored card with error message
- "Try Again" button to reload
- Log error details to console (development)

### Patterns to Follow

Reference `patterns.md`:
- **System Metrics Component** section (exact code)
- **Page Structure** section (admin dashboard layout)
- **Component Patterns** section (loading/error handling)
- **Query Patterns** section (tRPC usage)

### Testing Requirements

**Functional testing:**
1. Navigate to `/admin` as admin user
2. Verify system metrics load and display correctly
3. Check all 8 metrics present (totalUsers, totalTransactions, etc.)
4. Navigate to `/admin/users`
5. Verify user list loads
6. Test search: Type "test", verify results filter
7. Test role filter: Select "ADMIN", verify only admin users show
8. Test tier filter: Select "PREMIUM", verify only premium users show
9. Test pagination: Click "Load More", verify more users load
10. Test loading states: Throttle network, verify skeletons show
11. Test error states: Disconnect network, verify error displays

**Visual testing:**
1. Verify responsive layout (mobile, tablet, desktop)
2. Verify badges display correctly (colors, icons)
3. Verify consistent spacing and typography
4. Verify breadcrumbs display on both pages

**Edge case testing:**
1. Zero users (empty state)
2. Zero admin users (metric shows 0)
3. Very long user email (truncation)
4. No transaction count (displays 0)

**Coverage target:** Manual testing only (UI-heavy)

### Potential Split Strategy

If complexity is too high, consider splitting:

**Foundation (Primary Builder 5):**
- `/admin` page with SystemMetrics component
- Basic layout and routing

**Sub-builder 5A: User List**
- `/admin/users` page
- UserListTable component
- Search/filter/pagination
- Estimate: MEDIUM

**Recommendation:** Keep as single builder (pages are related, use same patterns)

---

## Builder Execution Order

### Parallel Group 1 (No dependencies)

**Builder-1: Database Schema & Migration**
- Must complete first
- Estimated time: 1-1.5 hours
- Blocking: All other builders

### Parallel Group 2 (Depends on Group 1)

**Builder-2: Backend API Layer (tRPC)**
- Can start after Builder 1
- Estimated time: 2-3 hours
- Blocking: Builders 4 & 5

**Builder-3: Middleware Security**
- Can start after Builder 1
- Estimated time: 1-1.5 hours
- Blocking: Builder 5 (admin pages)

### Parallel Group 3 (Depends on Groups 1 & 2)

**Builder-4: Navigation & Route Structure**
- Can start after Builders 1 & 2
- Estimated time: 2-3 hours
- Blocking: Builder 5 (needs routes)

**Builder-5: Admin Pages & Components**
- Can start after Builders 1, 2, 3, 4
- Estimated time: 2-2.5 hours
- Blocking: None (final)

### Timeline Visualization

```
Hour 0-1.5:  [Builder-1: Database]
             └─────────────────────┐
                                   │
Hour 1.5-3:                        ├─> [Builder-2: Backend] ────┐
                                   │                             │
Hour 1.5-3:                        └─> [Builder-3: Middleware] ─┤
                                                                 │
Hour 3-5:                                                        ├─> [Builder-4: Navigation] ──┐
                                                                 │                              │
Hour 5-7.5:                                                      └─────────────────────────────┴─> [Builder-5: Admin Pages]

Total: 6-8 hours (with some overlap)
```

## Integration Notes

### Builder Handoffs

**Builder 1 → Builders 2 & 3:**
- Prisma Client regenerated (`npx prisma generate`)
- TypeScript types available: `UserRole`, `SubscriptionTier`
- Verify imports work: `import { UserRole } from '@prisma/client'`

**Builder 2 → Builders 4 & 5:**
- tRPC procedures available on client
- Test with: `trpc.admin.systemMetrics.useQuery()`
- Verify autocomplete works in IDE

**Builder 3 → Builder 5:**
- Middleware protects `/admin` routes
- Test unauthorized access before building admin pages

**Builder 4 → Builder 5:**
- Route structure exists (empty pages)
- Navigation works (sidebar admin link, breadcrumbs)

### Shared Files Coordination

**middleware.ts:**
- Only Builder 3 modifies this
- No conflicts expected

**server/api/trpc.ts:**
- Only Builder 2 modifies this
- Add adminProcedure after protectedProcedure
- No conflicts expected

**server/api/root.ts:**
- Only Builder 2 modifies this
- Single line addition (register admin router)
- No conflicts expected

**DashboardSidebar.tsx:**
- Only Builder 4 modifies this
- Major refactor (careful merge if needed)
- No conflicts with other builders

### Conflict Prevention

1. **Builder 1 completes before others start** - No database conflicts
2. **Builders 2 & 3 work in separate files** - No merge conflicts
3. **Builders 4 & 5 work in separate directories** - No file conflicts
4. **All builders follow same patterns** - Consistent code style

### Integration Testing

After all builders complete:

1. **Smoke Test:** Sign in as admin, navigate through all new pages
2. **Security Test:** Sign in as regular user, attempt admin access
3. **Navigation Test:** Click all sidebar links, dropdown items, breadcrumbs
4. **Regression Test:** Verify all existing features still work
5. **Performance Test:** Check page load times, query response times

### Integration Checklist

- [ ] Database migration completed successfully
- [ ] Prisma Client types available throughout app
- [ ] Admin procedures callable from client
- [ ] Middleware blocks unauthorized admin access
- [ ] Navigation structure complete (sidebar, dropdown, breadcrumbs)
- [ ] Admin pages load and display data correctly
- [ ] All new routes working (no 404 errors)
- [ ] All old routes redirecting correctly
- [ ] No TypeScript errors
- [ ] No broken links
- [ ] No console errors in browser
- [ ] All success criteria met for each builder

---

**Builder Tasks Status:** COMPREHENSIVE
**Clear Dependencies:** YES
**Achievable Scope:** YES (6-8 hours realistic)
**Well-Sequenced:** YES
**Testable:** YES
**Ready for Execution:** YES
